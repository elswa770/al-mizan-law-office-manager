
import React, { useState, useRef, useEffect } from 'react';
import { AppUser, PermissionLevel, Case, Client, Hearing, Task, LegalReference } from '../types';
import { 
  Settings as SettingsIcon, Users, Lock, Shield, 
  Plus, Edit3, Trash2, Check, X, Eye, 
  Save, AlertCircle, Ban, Pencil, Key,
  Building, Phone, Mail, Globe, Upload, FileText, 
  Bell, Moon, Sun, Database, Download, Cloud, Loader2, FileJson, History, HardDrive, RotateCcw,
  Smartphone, LogOut, Archive, Clock, Printer, FileText as FileReport
} from 'lucide-react';
import { 
  updatePassword as updateFirebasePassword,
  getAuth,
  signOut as firebaseSignOut
} from 'firebase/auth';
import { auth } from '../services/firebaseConfig';
import { doc, setDoc, getDoc, updateDoc, collection, getDocs, deleteDoc } from 'firebase/firestore';
import { db } from '../services/firebaseConfig';

interface SettingsProps {
  users?: AppUser[];
  onAddUser?: (user: AppUser) => void;
  onUpdateUser?: (user: AppUser) => void;
  onDeleteUser?: (userId: string) => void;
  currentTheme?: 'light' | 'dark';
  onThemeChange?: (theme: 'light' | 'dark') => void;
  // Data props for backup
  cases?: Case[];
  clients?: Client[];
  hearings?: Hearing[];
  tasks?: Task[];
  references?: LegalReference[];
  onRestoreData?: (data: any) => void; 
  readOnly?: boolean;
}

// Complete list of modules for permission assignment
const MODULES = [
  { id: 'dashboard', label: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…' },
  { id: 'cases', label: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§' },
  { id: 'clients', label: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆÙƒÙ„ÙŠÙ†' },
  { id: 'hearings', label: 'Ø§Ù„Ø¬Ù„Ø³Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯' },
  { id: 'tasks', label: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…' }, 
  { id: 'documents', label: 'Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª' },
  { id: 'generator', label: 'Ù…Ù†Ø´Ø¦ Ø§Ù„Ø¹Ù‚ÙˆØ¯' }, // Added
  { id: 'fees', label: 'Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª)' },
  { id: 'expenses', label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©' },
  { id: 'reports', label: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' },
  { id: 'references', label: 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©' }, 
  { id: 'ai-assistant', label: 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ' },
  { id: 'locations', label: 'Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒÙ…' }, // Added
  { id: 'calculators', label: 'Ø§Ù„Ø­Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©' }, // Added
  { id: 'settings', label: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' },
];

const Settings: React.FC<SettingsProps> = ({ 
  users = [], onAddUser, onUpdateUser, onDeleteUser, currentTheme = 'light', onThemeChange,
  cases = [], clients = [], hearings = [], tasks = [], references = [],
  onRestoreData, readOnly = false
}) => {
  const [activeTab, setActiveTab] = useState<'general' | 'users' | 'security' | 'dataManagement' | 'reports'>('general');
  const [isSaving, setIsSaving] = useState(false);
  const [loading, setLoading] = useState(true);
  
  // Backup State
  const [isBackingUp, setIsBackingUp] = useState(false);
  const [isRestoring, setIsRestoring] = useState(false);
  const [lastBackupDate, setLastBackupDate] = useState<string | null>(localStorage.getItem('app_last_backup_date'));
  // Data Management State
  const [archiveDate, setArchiveDate] = useState('');
  const [autoBackupFrequency, setAutoBackupFrequency] = useState('weekly');
  const [restorePoint, setRestorePoint] = useState('');
  const [isCleaning, setIsCleaning] = useState(false);
  const [isImporting, setIsImporting] = useState(false);
  const [isExporting, setIsExporting] = useState(false);
  const [archivedCases, setArchivedCases] = useState<any[]>([]);
  const [backupPoints, setBackupPoints] = useState<any[]>([]);
  const [autoBackupSettings, setAutoBackupSettings] = useState<any>(null);
  // Reports State
  const [reportSettings, setReportSettings] = useState({
    includeArchived: false,
    dateRange: 'all',
    format: 'pdf',
    autoPrint: false
  });
  const [isGeneratingReport, setIsGeneratingReport] = useState(false);
  const reportRef = useRef<HTMLDivElement>(null);
  const importFileRef = useRef<HTMLInputElement>(null);
  const exportFileRef = useRef<HTMLInputElement>(null);
  const restoreFileRef = useRef<HTMLInputElement>(null);
  
  // Generate Report Handler
  const handleGenerateReport = async () => {
    setIsGeneratingReport(true);
    try {
      console.log('ğŸ”„ Generating report with settings:', reportSettings);
      
      // Filter data based on settings
      let filteredCases = [...cases];
      if (!reportSettings.includeArchived) {
        filteredCases = filteredCases.filter(c => c.status !== 'Ù…Ø¤Ø±Ø´ÙØ©');
      }
      
      if (reportSettings.dateRange !== 'all') {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (reportSettings.dateRange) {
          case 'month':
            cutoffDate.setMonth(now.getMonth() - 1);
            break;
          case 'quarter':
            cutoffDate.setMonth(now.getMonth() - 3);
            break;
          case 'year':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
        }
        
        filteredCases = filteredCases.filter(c => {
          const caseDate = c.startDate ? new Date(c.startDate) : new Date(c.year, 0, 1);
          return caseDate >= cutoffDate;
        });
      }
      
      // Generate report content
      const reportData = {
        title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§',
        generatedAt: new Date().toLocaleString('ar-SA'),
        settings: reportSettings,
        summary: {
          totalCases: filteredCases.length,
          openCases: filteredCases.filter(c => c.status === 'Ù…ÙØªÙˆØ­Ø©').length,
          closedCases: filteredCases.filter(c => c.status === 'Ù…ØºÙ„Ù‚Ø©').length,
          archivedCases: archivedCases.length
        },
        cases: filteredCases.map(c => ({
          number: c.caseNumber,
          title: c.title,
          client: c.clientName,
          status: c.status,
          court: c.court,
          year: c.year,
          startDate: c.startDate
        }))
      };
      
      // Generate and download report
      if (reportSettings.format === 'pdf') {
        // For now, generate JSON (can be enhanced with PDF library)
        const jsonString = JSON.stringify(reportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } else {
        // CSV format
        const csvContent = convertToCSV({ cases: filteredCases });
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
      
      alert(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ (${filteredCases.length} Ù‚Ø¶ÙŠØ©)`);
    } catch (error) {
      console.error('Report generation error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    } finally {
      setIsGeneratingReport(false);
    }
  };

  const handlePrintReport = () => {
    if (reportRef.current) {
      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(`
          <html dir="rtl">
            <head>
              <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; }
                .header { text-align: center; margin-bottom: 20px; }
                .summary { margin-bottom: 20px; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</h1>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-SA')}</p>
              </div>
              ${reportRef.current.innerHTML}
            </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      }
    }
  };
  
  // Security State
  const [securityData, setSecurityData] = useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: '',
    twoFactorEnabled: false
  });

  // User Modal State
  const [isUserModalOpen, setIsUserModalOpen] = useState(false);
  const [editingUser, setEditingUser] = useState<AppUser | null>(null);
  
  // User Form State
  const [formData, setFormData] = useState<Partial<AppUser>>({
    name: '',
    email: '',
    username: '',
    password: '',
    roleLabel: '',
    isActive: true,
    permissions: []
  });

  // --- General Settings State with Firebase Persistence ---
  const logoInputRef = useRef<HTMLInputElement>(null);
  
  // Initialize state from Firebase or LocalStorage or Defaults
  const [generalSettings, setGeneralSettings] = useState({
    firmName: 'Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ù„Ù„Ù…Ø­Ø§Ù…Ø§Ø© ÙˆØ§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©',
    firmSlogan: 'Ø§Ù„Ø¹Ø¯Ø§Ù„Ø© Ø­Ù‚ Ù„Ù„Ø¬Ù…ÙŠØ¹',
    taxNumber: '123-456-789',
    address: '15 Ø´Ø§Ø±Ø¹ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŒ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†ØŒ Ø§Ù„Ø¬ÙŠØ²Ø©',
    phone: '01000000000',
    email: 'info@almizan.com',
    website: 'www.almizan-law.com',
    currency: 'EGP',
    language: 'ar',
    theme: currentTheme,
    enableEmailNotifications: true,
    enableSystemNotifications: true,
    autoBackup: 'weekly',
    logoPreview: null as string | null
  });

  // Load settings from Firebase on component mount
  useEffect(() => {
    const loadWithTimeout = async () => {
      try {
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Connection timeout')), 10000)
        );
        
        await Promise.race([loadSettingsFromFirebase(), timeoutPromise]);
      } catch (error) {
        console.warn('Firebase connection timeout or error:', error);
        setLoading(false);
      }
    };
    
    loadWithTimeout();
  }, []);

  // Load data management data on component mount and tab change
  useEffect(() => {
    if (activeTab === 'dataManagement') {
      const loadDataWithTimeout = async () => {
        try {
          console.log('ğŸ”„ Starting data management load with extended timeout...');
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Connection timeout')), 20000)
          );
          
          await Promise.race([loadDataManagementData(), timeoutPromise]);
          console.log('âœ… Data management load completed successfully');
        } catch (error) {
          console.warn('âš ï¸ Data management loading timeout or error:', error);
          // Don't set empty arrays on timeout, keep existing data
          // This allows manual retry to work
        }
      };
      
      loadDataWithTimeout();
    }
  }, [activeTab]);

  const loadSettingsFromFirebase = async () => {
    try {
      setLoading(true);
      
      // Load general settings with timeout
      const generalDocPromise = getDoc(doc(db, 'settings', 'general'));
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Settings load timeout')), 5000)
      );
      
      const generalDoc = await Promise.race([generalDocPromise, timeoutPromise]);
      if (generalDoc && (generalDoc as any).exists()) {
        const data = (generalDoc as any).data() as any;
        setGeneralSettings(prev => ({ ...prev, ...data }));
      }
      
      // Load backup info with timeout
      const backupDocPromise = getDoc(doc(db, 'settings', 'backup'));
      const backupTimeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Backup info load timeout')), 3000)
      );
      
      const backupDoc = await Promise.race([backupDocPromise, backupTimeoutPromise]);
      if (backupDoc && (backupDoc as any).exists()) {
        const data = (backupDoc as any).data() as any;
        setLastBackupDate(data.lastBackupDate || null);
      }
      
      // Check localStorage as fallback
      const localBackup = localStorage.getItem('app_last_backup_date');
      if (localBackup && !lastBackupDate) {
        setLastBackupDate(localBackup);
      }
      
    } catch (error) {
      console.warn('Error loading settings from Firebase:', error);
      // Fallback to localStorage
      const localSettings = localStorage.getItem('app_general_settings');
      if (localSettings) {
        try {
          setGeneralSettings(JSON.parse(localSettings));
        } catch (e) {
          console.warn('Error parsing local settings:', e);
        }
      }
    } finally {
      setLoading(false);
    }
  };

  const saveSettingsToFirebase = async () => {
    if (readOnly) return;
    
    setIsSaving(true);
    try {
      // Save general settings
      await setDoc(doc(db, 'settings', 'general'), generalSettings);
      
      // Save backup info
      if (lastBackupDate) {
        await setDoc(doc(db, 'settings', 'backup'), { lastBackupDate });
      }
      
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
      console.error('Error saving settings to Firebase:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    } finally {
      setIsSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex items-center justify-center">
        <div className="text-center">
          <Loader2 className="w-8 h-8 animate-spin mx-auto mb-4 text-indigo-600" />
          <p className="text-slate-600 dark:text-slate-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Firebase...</p>
        </div>
      </div>
    );
  }

  // --- Handlers: Backup ---
  const handleCreateBackup = async () => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ø¢Ù†ØŸ')) return;
    
    setIsBackingUp(true);
    try {
      console.log('ğŸ’¾ Creating manual backup...');
      const backupData = {
        metadata: {
          generatedAt: new Date().toISOString(),
          version: '1.0',
          appName: 'Al-Mizan',
          recordCounts: {
            cases: cases.length,
            clients: clients.length,
            hearings: hearings.length,
            documents: 0, 
            users: users.length
          }
        },
        data: {
          generalSettings,
          users,
          cases,
          clients,
          hearings,
          tasks,
          references
        }
      };

      // Save to Firebase
      const backupId = `backup_${Date.now()}`;
      await setDoc(doc(db, 'backups', backupId), backupData);
      console.log(`âœ… Backup saved to Firebase with ID: ${backupId}`);

      // Download as JSON
      const jsonString = JSON.stringify(backupData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = `AlMizan_Backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      const now = new Date().toLocaleString('ar-EG');
      setLastBackupDate(now);
      localStorage.setItem('app_last_backup_date', now);
      
      // Reload backup points to show the new backup
      await loadDataManagementData();
      
      alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
      console.error('âŒ Backup creation error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
    } finally {
      setIsBackingUp(false);
    }
  };

  const handleRestoreBackup = async (e: React.ChangeEvent<HTMLInputElement>) => {
     const file = e.target.files?.[0];
     if (!file) return;

     if (!confirm("ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) {
        if (restoreFileRef.current) restoreFileRef.current.value = '';
        return;
     }

     setIsRestoring(true);
     try {
        const text = await file.text();
        const backupObj = JSON.parse(text);

        if (!backupObj.data || !backupObj.metadata || backupObj.metadata.appName !== 'Al-Mizan') {
           throw new Error("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Backup ØªÙ… ØªØµØ¯ÙŠØ±Ù‡ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù….");
        }

        // Restore to Firebase
        if (backupObj.data.cases) {
          for (const case_ of backupObj.data.cases) {
            await setDoc(doc(db, 'cases', case_.id), case_);
          }
        }

        if (backupObj.data.clients) {
          for (const client of backupObj.data.clients) {
            await setDoc(doc(db, 'clients', client.id), client);
          }
        }

        if (backupObj.data.users) {
          for (const user of backupObj.data.users) {
            await setDoc(doc(db, 'users', user.id), user);
          }
        }

        // Restore general settings
        if (backupObj.data.generalSettings) {
           setGeneralSettings(backupObj.data.generalSettings);
           await setDoc(doc(db, 'settings', 'general'), backupObj.data.generalSettings);
           if (onThemeChange && backupObj.data.generalSettings.theme) {
              onThemeChange(backupObj.data.generalSettings.theme);
           }
        }

        if (onRestoreData) {
           onRestoreData(backupObj.data);
        }

        alert('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
     } catch (error) {
        console.error("Restore Error:", error);
        alert("ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ù…Ù„Ù Ù‚Ø¯ ÙŠÙƒÙˆÙ† ØªØ§Ù„ÙØ§Ù‹.");
     } finally {
        setIsRestoring(false);
        if (restoreFileRef.current) restoreFileRef.current.value = '';
     }
  };

  // Load data management data from Firebase
  const loadDataManagementData = async () => {
    try {
      console.log('ğŸ”„ Starting to load data management data...');
      
      // Load backup points with timeout - ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
      console.log('ğŸ”„ Loading backup points from Firebase...');
      const backupPromise = getDocs(collection(db, 'backups'));
      const backupTimeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Backup points load timeout')), 15000)
      );
      
      const backupSnapshot = await Promise.race([backupPromise, backupTimeoutPromise]);
      console.log('ğŸ“‹ Backup snapshot result:', backupSnapshot);
      
      if (backupSnapshot && (backupSnapshot as any).docs) {
        const backupData = (backupSnapshot as any).docs.map((doc: any) => ({
          id: doc.id,
          ...doc.data()
        }));
        console.log('ğŸ“Š Raw backup data:', backupData);
        
        const sortedBackupData = backupData.sort((a: any, b: any) => {
          const dateA = new Date(a.createdAt || a.metadata?.generatedAt || 0).getTime();
          const dateB = new Date(b.createdAt || b.metadata?.generatedAt || 0).getTime();
          return dateB - dateA;
        });
        
        console.log(`ğŸ’¾ Loaded and sorted ${sortedBackupData.length} backup points:`, sortedBackupData);
        setBackupPoints(sortedBackupData);
      } else {
        console.log('ğŸ“­ No backup points found in Firebase - checking if snapshot exists');
        console.log('ğŸ“­ Snapshot type:', typeof backupSnapshot);
        console.log('ğŸ“­ Snapshot:', backupSnapshot);
        setBackupPoints([]);
      }

      // Load archived cases with timeout
      const archivedPromise = getDocs(collection(db, 'archived_cases'));
      const archivedTimeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Archived cases load timeout')), 10000)
      );
      
      const archivedSnapshot = await Promise.race([archivedPromise, archivedTimeoutPromise]);
      if (archivedSnapshot && (archivedSnapshot as any).docs) {
        const archivedData = (archivedSnapshot as any).docs.map((doc: any) => ({
          id: doc.id,
          ...doc.data()
        }));
        setArchivedCases(archivedData);
        console.log(`ğŸ“ Loaded ${archivedData.length} archived cases`);
      } else {
        setArchivedCases([]);
      }

      // Load auto backup settings with timeout
      const autoBackupPromise = getDoc(doc(db, 'settings', 'autoBackup'));
      const autoBackupTimeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Auto backup settings load timeout')), 8000)
      );
      
      const autoBackupDoc = await Promise.race([autoBackupPromise, autoBackupTimeoutPromise]);
      if (autoBackupDoc && (autoBackupDoc as any).exists()) {
        setAutoBackupSettings((autoBackupDoc as any).data());
        setAutoBackupFrequency((autoBackupDoc as any).data().frequency || 'weekly');
        console.log('âš™ï¸ Loaded auto backup settings:', (autoBackupDoc as any).data());
      } else {
        console.log('âš™ï¸ No auto backup settings found');
        setAutoBackupSettings(null);
      }
    } catch (error) {
      console.error('âŒ Error loading data management data:', error);
      console.error('âŒ Error details:', error.message);
      console.error('âŒ Error stack:', error.stack);
      
      // Only set empty arrays if this is a real error, not timeout
      if (!error.message.includes('timeout')) {
        setArchivedCases([]);
        setBackupPoints([]);
        setAutoBackupSettings(null);
      }
    }
  };

  const handleArchiveData = async () => {
    if (!archiveDate) {
      alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©');
      return;
    }
    
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ø±Ø´ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ù‚Ø¨Ù„ ${archiveDate}ØŸ`)) return;
    
    try {
      const cutoffDate = new Date(archiveDate);
      const oldCases = cases.filter((case_: any) => {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… year Ø£Ùˆ startDate Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† date ØºÙŠØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
        const caseDate = case_.startDate ? new Date(case_.startDate) : new Date(case_.year, 0, 1);
        return caseDate < cutoffDate && case_.status === 'Ù…ØºÙ„Ù‚Ø©';
      });
      
      console.log(`ğŸ”„ Found ${oldCases.length} cases to archive`);
      
      for (const case_ of oldCases) {
        await setDoc(doc(db, 'archived_cases', case_.id), {
          ...case_,
          archivedAt: new Date().toISOString(),
          originalCollection: 'cases',
          archiveReason: 'old_completed_case'
        });
        
        await deleteDoc(doc(db, 'cases', case_.id));
      }
      
      alert(`âœ… ØªÙ… Ø£Ø±Ø´ÙØ© ${oldCases.length} Ù‚Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­`);
      setArchiveDate('');
      
      // Reload archived cases
      await loadDataManagementData();
    } catch (error) {
      console.error('Archive error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ©');
    }
  };

  const handleImportData = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    
    setIsImporting(true);
    try {
      const text = await file.text();
      const data = file.name.endsWith('.csv') ? parseCSV(text) : JSON.parse(text);
      
      // Import based on data type
      if (data.cases) {
        for (const case_ of data.cases) {
          await setDoc(doc(db, 'cases', case_.id || Date.now().toString()), case_);
        }
      }
      
      if (data.clients) {
        for (const client of data.clients) {
          await setDoc(doc(db, 'clients', client.id || Date.now().toString()), client);
        }
      }
      
      alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
      console.error('Import error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    } finally {
      setIsImporting(false);
    }
  };

  const handleExportData = async (format: 'json' | 'csv' | 'excel') => {
    setIsExporting(true);
    try {
      const exportData = {
        cases: cases,
        clients: clients,
        hearings: hearings,
        tasks: tasks,
        exportedAt: new Date().toISOString()
      };
      
      let content: string;
      let filename: string;
      let mimeType: string;
      
      if (format === 'json') {
        content = JSON.stringify(exportData, null, 2);
        filename = `AlMizan_Export_${new Date().toISOString().split('T')[0]}.json`;
        mimeType = 'application/json';
      } else if (format === 'csv') {
        content = convertToCSV(exportData);
        filename = `AlMizan_Export_${new Date().toISOString().split('T')[0]}.csv`;
        mimeType = 'text/csv';
      } else {
        // Excel format (simplified)
        content = convertToCSV(exportData);
        filename = `AlMizan_Export_${new Date().toISOString().split('T')[0]}.csv`;
        mimeType = 'application/vnd.ms-excel';
      }
      
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¨ØµÙŠØºØ© ${format.toUpperCase()}`);
    } catch (error) {
      console.error('Export error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    } finally {
      setIsExporting(false);
    }
  };

  const handleAutoBackupSetup = async () => {
    try {
      const backupData = {
        frequency: autoBackupFrequency,
        enabled: true,
        lastBackup: new Date().toISOString(),
        createdAt: new Date().toISOString()
      };
      
      await setDoc(doc(db, 'settings', 'autoBackup'), backupData);
      
      setAutoBackupSettings(backupData);
      
      alert(`âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${autoBackupFrequency}`);
    } catch (error) {
      console.error('Auto backup setup error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
    }
  };

  const handleRestoreToPoint = async () => {
    if (!restorePoint) {
      alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©');
      return;
    }
    
    if (!confirm(`Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® ${restorePoint}. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) return;
    
    try {
      const backupDoc = await getDoc(doc(db, 'backups', restorePoint));
      if (backupDoc.exists()) {
        const backupData = backupDoc.data();
        
        // Restore all data
        if (backupData.data.cases) {
          for (const case_ of backupData.data.cases) {
            await setDoc(doc(db, 'cases', case_.id), case_);
          }
        }
        
        if (backupData.data.clients) {
          for (const client of backupData.data.clients) {
            await setDoc(doc(db, 'clients', client.id), client);
          }
        }
        
        alert('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        setRestorePoint('');
        
        // Reload backup points
        await loadDataManagementData();
      } else {
        alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
      }
    } catch (error) {
      console.error('Restore error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  };

  // Generate Report Handler
  const handleGenerateReport = async () => {
    setIsGeneratingReport(true);
    try {
      console.log('ğŸ”„ Generating report with settings:', reportSettings);
      
      // Filter data based on settings
      let filteredCases = [...cases];
      if (!reportSettings.includeArchived) {
        filteredCases = filteredCases.filter(c => c.status !== 'Ù…Ø¤Ø±Ø´ÙØ©');
      }
      
      if (reportSettings.dateRange !== 'all') {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (reportSettings.dateRange) {
          case 'month':
            cutoffDate.setMonth(now.getMonth() - 1);
            break;
          case 'quarter':
            cutoffDate.setMonth(now.getMonth() - 3);
            break;
          case 'year':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
        }
        
        filteredCases = filteredCases.filter(c => {
          const caseDate = c.startDate ? new Date(c.startDate) : new Date(c.year, 0, 1);
          return caseDate >= cutoffDate;
        });
      }
      
      // Generate report content
      const reportData = {
        title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§',
        generatedAt: new Date().toLocaleString('ar-SA'),
        settings: reportSettings,
        summary: {
          totalCases: filteredCases.length,
          openCases: filteredCases.filter(c => c.status === 'Ù…ÙØªÙˆØ­Ø©').length,
          closedCases: filteredCases.filter(c => c.status === 'Ù…ØºÙ„Ù‚Ø©').length,
          archivedCases: archivedCases.length
        },
        cases: filteredCases.map(c => ({
          number: c.caseNumber,
          title: c.title,
          client: c.clientName,
          status: c.status,
          court: c.court,
          year: c.year,
          startDate: c.startDate
        }))
      };
      
      // Generate and download report
      if (reportSettings.format === 'pdf') {
        // For now, generate JSON (can be enhanced with PDF library)
        const jsonString = JSON.stringify(reportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } else {
        // CSV format
        const csvContent = convertToCSV({ cases: filteredCases });
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
      
      alert(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ (${filteredCases.length} Ù‚Ø¶ÙŠØ©)`);
    } catch (error) {
      console.error('Report generation error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    } finally {
      setIsGeneratingReport(false);
    }
  };

  const handlePrintReport = () => {
    if (reportRef.current) {
      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(`
          <html dir="rtl">
            <head>
              <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; }
                .header { text-align: center; margin-bottom: 20px; }
                .summary { margin-bottom: 20px; }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</h1>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleString('ar-SA')}</p>
              </div>
              ${reportRef.current.innerHTML}
            </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.print();
      }
  const handleCleanData = async () => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©.')) return;
    
    setIsCleaning(true);
    try {
      // Clean temporary files
      const tempDocs = await getDocs(collection(db, 'temp_files'));
      for (const doc of tempDocs.docs) {
        await deleteDoc(doc.ref);
      }
      
      // Clean old logs
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - 30);
      
      alert('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      await loadDataManagementData();
    } catch (error) {
      console.error('Clean data error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    } finally {
      setIsCleaning(false);
    }
  };

  const convertToCSV = (text: string) => {
    const lines = text.split('\n');
    const headers = lines[0].split(',');
    const result = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',');
      const obj: any = {};
      headers.forEach((header, index) => {
        obj[header.trim()] = values[index]?.trim();
      });
      result.push(obj);
    }
    
    return result;
  };

  const handleCleanData = async () => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©.')) return;
    
    setIsCleaning(true);
    try {
      // Clean temporary files
      const tempDocs = await getDocs(collection(db, 'temp_files'));
      for (const doc of tempDocs.docs) {
        await deleteDoc(doc.ref);
      }
      
      // Clean old logs
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - 30);
      
      const oldLogs = await getDocs(collection(db, 'activity_logs'));
      for (const doc of oldLogs.docs) {
        const logData = doc.data();
        if (new Date(logData.timestamp) < cutoffDate) {
          await deleteDoc(doc.ref);
        }
      }
      
      alert('âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      await loadDataManagementData();
    } catch (error) {
      console.error('Clean data error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    } finally {
      setIsCleaning(false);
    }
  };

  const handleGenerateReport = async () => {
    setIsGeneratingReport(true);
    try {
      console.log('ğŸ”„ Generating report with settings:', reportSettings);
      
      // Filter data based on settings
      let filteredCases = [...cases];
      if (!reportSettings.includeArchived) {
        filteredCases = filteredCases.filter(c => c.status !== 'Ù…Ø¤Ø±Ø´ÙØ©');
      }
      
      if (reportSettings.dateRange !== 'all') {
        const now = new Date();
        let cutoffDate = new Date();
        
        switch (reportSettings.dateRange) {
          case 'month':
            cutoffDate.setMonth(now.getMonth() - 1);
            break;
          case 'quarter':
            cutoffDate.setMonth(now.getMonth() - 3);
            break;
          case 'year':
            cutoffDate.setFullYear(now.getFullYear() - 1);
            break;
        }
        
        filteredCases = filteredCases.filter(c => {
          const caseDate = c.startDate ? new Date(c.startDate) : new Date(c.year, 0, 1);
          return caseDate >= cutoffDate;
        });
      }
      
      // Generate report content
      const reportData = {
        title: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§',
        generatedAt: new Date().toLocaleString('ar-SA'),
        settings: reportSettings,
        summary: {
          totalCases: filteredCases.length,
          openCases: filteredCases.filter(c => c.status === 'Ù…ÙØªÙˆØ­Ø©').length,
          closedCases: filteredCases.filter(c => c.status === 'Ù…ØºÙ„Ù‚Ø©').length,
          archivedCases: archivedCases.length
        },
        cases: filteredCases.map(c => ({
          number: c.caseNumber,
          title: c.title,
          client: c.clientName,
          status: c.status,
          court: c.court,
          year: c.year,
          startDate: c.startDate
        }))
      };
      
      // Generate and download report
      if (reportSettings.format === 'pdf') {
        // For now, generate JSON (can be enhanced with PDF library)
        const jsonString = JSON.stringify(reportData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } else {
        // CSV format
        const csvContent = convertToCSV({ cases: filteredCases });
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
      
      alert(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ (${filteredCases.length} Ù‚Ø¶ÙŠØ©)`);
    } catch (error) {
      console.error('Report generation error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    } finally {
      setIsGeneratingReport(false);
    }
  };

  const handlePrintReport = () => {
    if (reportRef.current) {
      const printWindow = window.open('', '_blank');
      if (printWindow) {
        printWindow.document.write(`
          <html dir="rtl">
            <head>
              <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; }
                .header { text-align: center; margin-bottom: 20px; }
                .summary { margin-bottom: 20px; }
              </style>
            </head>
            <body>
  const renderReportsTab = () => (
    <div className="space-y-6 animate-in fade-in">
      <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-6">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Report Settings */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <FileReport className="w-8 h-8 text-green-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
          </div>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <select
                value={reportSettings.dateRange}
                onChange={(e) => setReportSettings({...reportSettings, dateRange: e.target.value})}
                className="w-full border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 dark:text-white"
                disabled={readOnly}
              >
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª</option>
                <option value="month">Ø¢Ø®Ø± Ø´Ù‡Ø±</option>
                <option value="quarter">Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±</option>
                <option value="year">Ø¢Ø®Ø± Ø³Ù†Ø©</option>
              </select>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ØµÙŠØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
              <select
                value={reportSettings.format}
                onChange={(e) => setReportSettings({...reportSettings, format: e.target.value})}
                className="w-full border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 dark:text-white"
                disabled={readOnly}
              >
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
                <option value="csv">CSV</option>
              </select>
            </div>
            
            <div className="flex items-center gap-3">
              <input
                type="checkbox"
                id="includeArchived"
                checked={reportSettings.includeArchived}
                onChange={(e) => setReportSettings({...reportSettings, includeArchived: e.target.checked})}
                className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
                disabled={readOnly}
              />
              <label htmlFor="includeArchived" className="text-sm text-slate-700 dark:text-slate-300">
                ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©
              </label>
            </div>
          </div>
        </div>

        {/* Generate Report */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <Printer className="w-8 h-8 text-blue-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h4>
          </div>
          <div className="space-y-3">
            <button
              onClick={handleGenerateReport}
              disabled={isGeneratingReport || readOnly}
              className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isGeneratingReport ? (
                <span className="flex items-center justify-center gap-2">
                  <Loader2 className="w-4 h-4 animate-spin" />
                  Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...
                </span>
              ) : 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±'}
            </button>
            
            <button
              onClick={handlePrintReport}
              disabled={readOnly}
              className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              <Printer className="w-4 h-4 inline ml-2" /> Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
            </button>
          </div>
        </div>
      </div>

      {/* Report Summary */}
      <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
        <div className="flex items-center gap-3 mb-4">
          <FileText className="w-8 h-8 text-purple-600" />
          <h4 className="font-bold text-slate-800 dark:text-white">Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h4>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-indigo-600 dark:text-indigo-400">{cases.length}</div>
            <div className="text-sm text-slate-600 dark:text-slate-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</div>
          </div>
          <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-green-600 dark:text-green-400">{cases.filter(c => c.status === 'Ù…ÙØªÙˆØ­Ø©').length}</div>
            <div className="text-sm text-slate-600 dark:text-slate-400">Ù‚Ø¶Ø§ÙŠØ§ Ù…ÙØªÙˆØ­Ø©</div>
          </div>
          <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg text-center">
            <div className="text-2xl font-bold text-red-600 dark:text-red-400">{cases.filter(c => c.status === 'Ù…ØºÙ„Ù‚Ø©').length}</div>
            <div className="text-sm text-slate-600 dark:text-slate-400">Ù‚Ø¶Ø§ÙŠØ§ Ù…ØºÙ„Ù‚Ø©</div>
          </div>
        </div>
        
        <div className="mt-6">
          <h5 className="font-bold text-slate-800 dark:text-white mb-3">Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h5>
          <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg">
            <p className="text-sm text-slate-600 dark:text-slate-400">
              Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù€ <span className="font-bold text-indigo-600">{cases.length}</span> Ù‚Ø¶ÙŠØ©
              {reportSettings.dateRange !== 'all' && (
                <span> Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ({reportSettings.dateRange === 'month' ? 'Ø¢Ø®Ø± Ø´Ù‡Ø±' : reportSettings.dateRange === 'quarter' ? 'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±' : 'Ø¢Ø®Ø± Ø³Ù†Ø©'})</span>
              )}
              {reportSettings.includeArchived && (
                <span> Ù…Ø¹ ØªØ¶Ù…ÙŠÙ† <span className="font-bold text-orange-600">{archivedCases.length}</span> Ù‚Ø¶ÙŠØ© Ù…Ø¤Ø±Ø´ÙØ©</span>
              )}
              Ø¨ØµÙŠØºØ© <span className="font-bold text-green-600">{reportSettings.format.toUpperCase()}</span>
            </p>
          </div>
        </div>
      </div>
    </div>
  );

  const parseCSV = (text: string) => {
    const lines = text.split('\n');
    const headers = lines[0].split(',');
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',');
      const obj: any = {};
      headers.forEach((header, index) => {
        obj[header.trim()] = values[index]?.trim();
      });
      data.push(obj);
    }
    
    return { cases: data };
  };

  const convertToCSV = (data: any) => {
    if (!data.cases || data.cases.length === 0) return '';
    
    const headers = Object.keys(data.cases[0]);
    const csvHeaders = headers.join(',');
    const csvRows = data.cases.map((row: any) => 
      headers.map(header => `"${row[header] || ''}"`).join(',')
    );
    
    return [csvHeaders, ...csvRows].join('\n');
  };
  const handlePasswordChange = (e: React.FormEvent) => {
    e.preventDefault();
    if (securityData.newPassword !== securityData.confirmPassword) {
      alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
      return;
    }
    setIsSaving(true);
    setTimeout(() => {
      setIsSaving(false);
      setSecurityData(prev => ({ ...prev, currentPassword: '', newPassword: '', confirmPassword: '' }));
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­');
    }, 1000);
  };

  // --- Handlers: Users ---

  const openAddUser = () => {
    setEditingUser(null);
    setFormData({
      name: '',
      email: '',
      username: '',
      password: '',
      roleLabel: 'Ù…ÙˆØ¸Ù',
      isActive: true,
      permissions: MODULES.map(m => ({ moduleId: m.id, access: 'none' as PermissionLevel }))
    });
    setIsUserModalOpen(true);
  };

  const openEditUser = (user: AppUser) => {
    setEditingUser(user);
    const mergedPermissions = MODULES.map(m => {
      const existing = user.permissions.find(p => p.moduleId === m.id);
      return existing || { moduleId: m.id, access: 'none' as PermissionLevel };
    });

    setFormData({
      ...user,
      password: '', 
      permissions: mergedPermissions
    });
    setIsUserModalOpen(true);
  };

  const handlePermissionChange = (moduleId: string, access: PermissionLevel) => {
    const updatedPermissions = formData.permissions?.map(p => 
      p.moduleId === moduleId ? { ...p, access } : p
    );
    setFormData({ ...formData, permissions: updatedPermissions });
  };

  const handleSaveUser = (e: React.FormEvent) => {
    e.preventDefault();
    if (!formData.name || !formData.email) return;

    if (!editingUser && !formData.password) {
      alert('ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯');
      return;
    }

    if (editingUser && onUpdateUser) {
      const updatedUser = { ...editingUser, ...formData };
      if (!formData.password) {
         updatedUser.password = editingUser.password;
      }
      onUpdateUser(updatedUser as AppUser);
    } else if (onAddUser) {
      const newUser: AppUser = {
        id: Math.random().toString(36).substring(2, 9),
        name: formData.name!,
        email: formData.email!,
        username: formData.username,
        password: formData.password,
        roleLabel: formData.roleLabel || 'Ù…ÙˆØ¸Ù',
        isActive: formData.isActive || true,
        permissions: formData.permissions || [],
        avatar: undefined
      };
      onAddUser(newUser);
    }
    setIsUserModalOpen(false);
  };

  // --- Handlers: General Settings ---

  const handleLogoUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        setGeneralSettings(prev => ({ ...prev, logoPreview: reader.result as string }));
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSaveSettings = () => {
    if (readOnly) {
       alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
       return;
    }
    saveSettingsToFirebase();
  };

  const handleThemeSwitch = (theme: 'light' | 'dark') => {
    setGeneralSettings(prev => ({ ...prev, theme }));
    if (onThemeChange) {
      onThemeChange(theme);
    }
  };

  const renderDataManagementTab = () => (
    <div className="space-y-6 animate-in fade-in">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h3 className="text-xl font-bold text-slate-800 dark:text-white">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
          <p className="text-sm text-slate-500 dark:text-slate-400">Ø£Ø±Ø´ÙØ©ØŒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŒ ØªØµØ¯ÙŠØ±ØŒ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØŒ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {/* Archive Data Card */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <Archive className="w-8 h-8 text-purple-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
          </div>
          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Ø£Ø±Ø´ÙØ© Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          </p>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©</label>
              <input
                type="date"
                value={archiveDate}
                onChange={(e) => setArchiveDate(e.target.value)}
                className="w-full border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 dark:text-white"
                disabled={readOnly}
              />
            </div>
            <button
              onClick={handleArchiveData}
              disabled={readOnly}
              className="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¢Ù†
            </button>
            {archivedCases.length > 0 && (
              <div className="text-xs text-slate-500 dark:text-slate-400">
                Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©: {archivedCases.length}
              </div>
            )}
          </div>
        </div>

        {/* Import/Export Card */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <Upload className="w-8 h-8 text-blue-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±</h4>
          </div>
          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ØµÙŠØº Ù…ØªØ¹Ø¯Ø¯Ø©
          </p>
          <div className="space-y-3">
            <div>
              <label className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer block text-center">
                {isImporting ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...' : 'Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel/CSV'}
                <input
                  ref={importFileRef}
                  type="file"
                  accept=".csv,.xlsx,.json"
                  onChange={handleImportData}
                  className="hidden"
                  disabled={isImporting || readOnly}
                />
              </label>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => handleExportData('json')}
                disabled={isExporting || readOnly}
                className="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm"
              >
                JSON
              </button>
              <button
                onClick={() => handleExportData('csv')}
                disabled={isExporting || readOnly}
                className="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm"
              >
                CSV
              </button>
              <button
                onClick={() => handleExportData('excel')}
                disabled={isExporting || readOnly}
                className="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm"
              >
                Excel
              </button>
            </div>
          </div>
        </div>

        {/* Auto Backup Card */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <Clock className="w-8 h-8 text-orange-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ</h4>
          </div>
          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¯ÙˆØ±ÙŠ
          </p>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„ØªÙƒØ±Ø§Ø±</label>
              <select
                value={autoBackupFrequency}
                onChange={(e) => setAutoBackupFrequency(e.target.value)}
                className="w-full border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 dark:text-white"
                disabled={readOnly}
              >
                <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
                <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</option>
                <option value="monthly">Ø´Ù‡Ø±ÙŠ</option>
              </select>
            </div>
            <button
              onClick={handleAutoBackupSetup}
              disabled={readOnly}
              className="w-full bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            </button>
            {autoBackupSettings && (
              <div className="text-xs text-slate-500 dark:text-slate-400">
                Ø§Ù„Ø­Ø§Ù„Ø©: {autoBackupSettings.enabled ? 'Ù…ÙØ¹Ù„' : 'Ù…Ø¹Ø·Ù„'}
                <br />
                Ø¢Ø®Ø± Ù†Ø³Ø®Ø©: {autoBackupSettings.lastBackup ? new Date(autoBackupSettings.lastBackup).toLocaleDateString('ar-SA') : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}
              </div>
            )}
          </div>
        </div>

        {/* Restore Data Card */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <RotateCcw className="w-8 h-8 text-indigo-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
          </div>
          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù†Ù‚Ø·Ø© Ø²Ù…Ù†ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©
          </p>
          <div className="space-y-3">
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ù†Ù‚Ø·Ø© Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</label>
              <select
                value={restorePoint}
                onChange={(e) => setRestorePoint(e.target.value)}
                className="w-full border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 dark:text-white"
                disabled={readOnly}
              >
                <option value="">Ø§Ø®ØªØ± Ù†Ù‚Ø·Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø©</option>
                {backupPoints.map((point: any) => (
                  <option key={point.id} value={point.id}>
                    {new Date(point.createdAt || point.metadata?.generatedAt).toLocaleDateString('ar-SA')} 
                    {point.metadata?.version && ` (${point.metadata.version})`}
                  </option>
                ))}
              </select>
            </div>
            <button
              onClick={() => loadDataManagementData()}
              disabled={readOnly}
              className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors mb-2"
            >
              Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button
              onClick={handleRestoreToPoint}
              disabled={readOnly}
              className="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¢Ù†
            </button>
            {backupPoints.length > 0 && (
              <>
                <div className="text-xs text-slate-500 dark:text-slate-400">
                  Ø¹Ø¯Ø¯ Ù†Ù‚Ø§Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: {backupPoints.length}
                </div>
                <div className="text-xs text-blue-500 dark:text-blue-400">
                  Ø¢Ø®Ø± Ù†Ø³Ø®Ø©: {backupPoints[0] && new Date(backupPoints[0].createdAt || backupPoints[0].metadata?.generatedAt).toLocaleDateString('ar-SA')}
                </div>
              </>
            )}
            {backupPoints.length === 0 && (
              <div className="text-xs text-orange-500 dark:text-orange-400">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©
              </div>
            )}
          </div>
        </div>

        {/* Clean Data Card */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <Trash2 className="w-8 h-8 text-red-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
          </div>
          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
          </p>
          <div className="space-y-3">
            <div className="text-xs text-slate-500 dark:text-slate-400">
              Ø³ÙŠØªÙ… Ø­Ø°Ù:
              <ul className="list-disc list-inside mt-1 space-y-1">
                <li>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©</li>
                <li>Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£Ù‚Ø¯Ù… Ù…Ù† 30 ÙŠÙˆÙ…)</li>
                <li>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</li>
              </ul>
            </div>
            <button
              onClick={handleCleanData}
              disabled={isCleaning || readOnly}
              className="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isCleaning ? (
                <span className="flex items-center justify-center gap-2">
                  <Loader2 className="w-4 h-4 animate-spin" />
                  Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ...
                </span>
              ) : 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¢Ù†'}
            </button>
          </div>
        </div>

        {/* Manual Backup Card */}
        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex items-center gap-3 mb-4">
            <Database className="w-8 h-8 text-green-600" />
            <h4 className="font-bold text-slate-800 dark:text-white">Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙŠØ¯ÙˆÙŠ</h4>
          </div>
          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
            Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙƒØ§Ù…Ù„Ø© ÙÙˆØ±Ø§Ù‹
          </p>
          <div className="space-y-3">
            <div>
              <label className="text-sm text-slate-700 dark:text-slate-300">Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</label>
              <div className="text-xs text-slate-500 dark:text-slate-400">
                {lastBackupDate ? new Date(lastBackupDate).toLocaleString('ar-SA') : 'Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ø¹Ø¯'}
              </div>
            </div>
            <button
              onClick={handleCreateBackup}
              disabled={isBackingUp || readOnly}
              className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isBackingUp ? (
                <span className="flex items-center justify-center gap-2">
                  <Loader2 className="w-4 h-4 animate-spin" />
                  Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø³Ø®...
                </span>
              ) : 'Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø¢Ù†'}
            </button>
          </div>
        </div>
      </div>

      {/* Archived Cases Table */}
      {archivedCases.length > 0 && (
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
          <h4 className="font-bold text-slate-800 dark:text-white mb-4">Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</h4>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="border-b border-slate-200 dark:border-slate-700">
                  <th className="text-right pb-3 font-medium text-slate-700 dark:text-slate-300">Ø±Ù‚Ù… Ø§Ù„Ù‚Ø¶ÙŠØ©</th>
                  <th className="text-right pb-3 font-medium text-slate-700 dark:text-slate-300">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                  <th className="text-right pb-3 font-medium text-slate-700 dark:text-slate-300">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©</th>
                  <th className="text-right pb-3 font-medium text-slate-700 dark:text-slate-300">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                {archivedCases.slice(0, 5).map((case_: any) => (
                  <tr key={case_.id} className="border-b border-slate-100 dark:border-slate-800">
                    <td className="py-3 text-slate-600 dark:text-slate-400">{case_.caseNumber || case_.id}</td>
                    <td className="py-3 text-slate-600 dark:text-slate-400">{case_.title || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td className="py-3 text-slate-600 dark:text-slate-400">
                      {new Date(case_.archivedAt).toLocaleDateString('ar-SA')}
                    </td>
                    <td className="py-3">
                      <button
                        onClick={() => handleRestoreArchivedCase(case_.id)}
                        disabled={readOnly}
                        className="text-indigo-600 hover:text-indigo-700 text-sm font-medium disabled:opacity-50"
                      >
                        Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );

  // Restore archived case
  const handleRestoreArchivedCase = async (archivedCaseId: string) => {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø¶ÙŠØ©ØŸ')) return;
    
    try {
      const archivedDoc = await getDoc(doc(db, 'archived_cases', archivedCaseId));
      if (archivedDoc.exists()) {
        const caseData = archivedDoc.data();
        
        // Restore to main collection
        await setDoc(doc(db, 'cases', archivedCaseId), {
          ...caseData,
          restoredAt: new Date().toISOString()
        });
        
        // Delete from archive
        await deleteDoc(doc(db, 'archived_cases', archivedCaseId));
        
        alert('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        await loadDataManagementData();
      }
    } catch (error) {
      console.error('Restore archived case error:', error);
      alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø¶ÙŠØ©');
    }
  };

  const renderGeneralTab = () => (
    <div className="space-y-6 animate-in fade-in">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h3 className="text-xl font-bold text-slate-800 dark:text-white">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
          <p className="text-sm text-slate-500 dark:text-slate-400">ØªØ®ØµÙŠØµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨ ÙˆØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</p>
        </div>
        {!readOnly && (
          <button 
            onClick={handleSaveSettings}
            disabled={isSaving}
            className="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-md shadow-indigo-200 dark:shadow-none transition-all disabled:opacity-70 disabled:cursor-not-allowed"
          >
            {isSaving ? (
               <><Loader2 className="w-4 h-4 animate-spin" /> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</>
            ) : (
               <><Save className="w-4 h-4" /> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</>
            )}
          </button>
        )}
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
        
        {/* Column 1: Identity & Logo */}
        <div className="xl:col-span-2 space-y-6">
          {/* Identity Card */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h4 className="font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-3">
              <Building className="w-5 h-5 text-indigo-600" /> Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠØ©
            </h4>
            
            <div className="flex flex-col md:flex-row gap-6">
              {/* Logo Upload */}
              <div className="shrink-0 flex flex-col items-center gap-3">
                <div 
                  onClick={() => !readOnly && logoInputRef.current?.click()}
                  className={`w-32 h-32 rounded-full border-2 border-dashed border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 flex items-center justify-center ${!readOnly ? 'cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-slate-600' : ''} transition-all overflow-hidden relative group`}
                >
                  {generalSettings.logoPreview ? (
                    <img src={generalSettings.logoPreview} alt="Logo" className="w-full h-full object-cover" />
                  ) : (
                    <Upload className="w-8 h-8 text-slate-400 group-hover:text-indigo-500" />
                  )}
                  {!readOnly && (
                    <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                      <span className="text-white text-xs font-bold">ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø¹Ø§Ø±</span>
                    </div>
                  )}
                </div>
                <input type="file" ref={logoInputRef} className="hidden" onChange={handleLogoUpload} accept="image/*" disabled={readOnly} />
                <p className="text-xs text-slate-500 dark:text-slate-400">Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ (PNG/JPG)</p>
              </div>

              {/* Basic Inputs */}
              <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨ / Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
                  <input 
                    type="text" 
                    readOnly={readOnly}
                    className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                    value={generalSettings.firmName}
                    onChange={e => setGeneralSettings({...generalSettings, firmName: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù„ÙØ¸ÙŠ (Slogan)</label>
                  <input 
                    type="text" 
                    readOnly={readOnly}
                    className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                    value={generalSettings.firmSlogan}
                    onChange={e => setGeneralSettings({...generalSettings, firmSlogan: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨ÙŠ / Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label>
                  <input 
                    type="text" 
                    readOnly={readOnly}
                    className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                    value={generalSettings.taxNumber}
                    onChange={e => setGeneralSettings({...generalSettings, taxNumber: e.target.value})}
                  />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                  <input 
                    type="text" 
                    readOnly={readOnly}
                    className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                    value={generalSettings.address}
                    onChange={e => setGeneralSettings({...generalSettings, address: e.target.value})}
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Contact Info Card */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h4 className="font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-3">
              <Phone className="w-5 h-5 text-indigo-600" /> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„
            </h4>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 flex items-center gap-2"><Phone className="w-3 h-3"/> Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input 
                  type="text" 
                  readOnly={readOnly}
                  className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-left dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                  dir="ltr"
                  value={generalSettings.phone}
                  onChange={e => setGeneralSettings({...generalSettings, phone: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 flex items-center gap-2"><Mail className="w-3 h-3"/> Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input 
                  type="email" 
                  readOnly={readOnly}
                  className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-left dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                  dir="ltr"
                  value={generalSettings.email}
                  onChange={e => setGeneralSettings({...generalSettings, email: e.target.value})}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1 flex items-center gap-2"><Globe className="w-3 h-3"/> Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input 
                  type="text" 
                  readOnly={readOnly}
                  className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-left dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                  dir="ltr"
                  value={generalSettings.website}
                  onChange={e => setGeneralSettings({...generalSettings, website: e.target.value})}
                />
              </div>
            </div>
          </div>
        </div>

        {/* Column 2: System & Notifications */}
        <div className="space-y-6">
          {/* System Preferences */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h4 className="font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-3">
              <SettingsIcon className="w-5 h-5 text-indigo-600" /> ØªÙØ¶ÙŠÙ„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            </h4>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label>
                <select 
                  disabled={readOnly}
                  className="w-full border p-2.5 rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                  value={generalSettings.currency}
                  onChange={e => setGeneralSettings({...generalSettings, currency: e.target.value})}
                >
                  <option value="EGP">Ø§Ù„Ø¬Ù†ÙŠÙ‡ Ø§Ù„Ù…ØµØ±ÙŠ (EGP)</option>
                  <option value="USD">Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± Ø§Ù„Ø£Ù…Ø±ÙŠÙƒÙŠ (USD)</option>
                  <option value="SAR">Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ (SAR)</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ù„ØºØ©</label>
                <select 
                  disabled={readOnly}
                  className="w-full border p-2.5 rounded-lg bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                  value={generalSettings.language}
                  onChange={e => setGeneralSettings({...generalSettings, language: e.target.value})}
                >
                  <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                  <option value="en">English</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ù…Ø¸Ù‡Ø±</label>
                <div className="grid grid-cols-2 gap-2">
                  <button 
                    onClick={() => handleThemeSwitch('light')}
                    className={`p-2 rounded-lg border flex items-center justify-center gap-2 transition-all ${
                      generalSettings.theme === 'light' 
                        ? 'border-indigo-600 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-200' 
                        : 'border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'
                    }`}
                  >
                    <Sun className="w-4 h-4" /> ÙØ§ØªØ­
                  </button>
                  <button 
                    onClick={() => handleThemeSwitch('dark')}
                    className={`p-2 rounded-lg border flex items-center justify-center gap-2 transition-all ${
                      generalSettings.theme === 'dark' 
                        ? 'border-indigo-600 bg-indigo-50 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-200' 
                        : 'border-slate-200 dark:border-slate-600 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'
                    }`}
                  >
                    <Moon className="w-4 h-4" /> Ø¯Ø§ÙƒÙ†
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Notifications */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
            <h4 className="font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-3">
              <Bell className="w-5 h-5 text-amber-500" /> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
            </h4>
            <div className="space-y-3">
              <label className="flex items-center justify-between cursor-pointer p-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span className="text-sm font-medium text-slate-700 dark:text-slate-300">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</span>
                <div className="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" className="sr-only peer" checked={generalSettings.enableSystemNotifications} onChange={e => !readOnly && setGeneralSettings({...generalSettings, enableSystemNotifications: e.target.checked})} disabled={readOnly} />
                  <div className="w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                </div>
              </label>
              <label className="flex items-center justify-between cursor-pointer p-2 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors">
                <span className="text-sm font-medium text-slate-700 dark:text-slate-300">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span>
                <div className="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" className="sr-only peer" checked={generalSettings.enableEmailNotifications} onChange={e => !readOnly && setGeneralSettings({...generalSettings, enableEmailNotifications: e.target.checked})} disabled={readOnly} />
                  <div className="w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                </div>
              </label>
            </div>
          </div>

          {/* Data Management */}
          <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden">
            <div className="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
            <h4 className="font-bold text-slate-800 dark:text-slate-100 mb-6 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-3">
              <Database className="w-5 h-5 text-green-600" /> Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Backup)
            </h4>
            
            <div className="space-y-4">
               {/* Export Backup */}
               <div>
                  <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                  <button 
                    onClick={handleCreateBackup}
                    disabled={isBackingUp || readOnly}
                    className="w-full flex items-center justify-center gap-3 p-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl font-bold hover:shadow-lg hover:from-green-700 hover:to-emerald-700 transition-all disabled:opacity-70"
                  >
                     {isBackingUp ? (
                        <><Loader2 className="w-5 h-5 animate-spin" /> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</>
                     ) : (
                        <><Download className="w-5 h-5" /> ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© (.JSON)</>
                     )}
                  </button>
                  {lastBackupDate && (
                     <div className="mt-2 text-center text-[10px] text-slate-400 flex items-center justify-center gap-1">
                        <History className="w-3 h-3" />
                        Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ù…Ø­ÙÙˆØ¸Ø©: {lastBackupDate}
                     </div>
                  )}
               </div>

               {/* Import Backup */}
               <div className="pt-2 border-t border-slate-100 dark:border-slate-700">
                  <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø© (Restore)</label>
                  <label 
                    onClick={() => { if(!isRestoring && !readOnly) restoreFileRef.current?.click(); }}
                    className={`w-full flex flex-col items-center justify-center gap-2 p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 hover:border-indigo-400 transition-all group ${isRestoring || readOnly ? 'opacity-50 cursor-not-allowed' : ''}`}
                  >
                     {isRestoring ? (
                        <div className="flex flex-col items-center gap-2 text-indigo-600">
                           <Loader2 className="w-6 h-6 animate-spin" />
                           <span className="text-xs font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span>
                        </div>
                     ) : (
                        <>
                           <RotateCcw className="w-6 h-6 text-slate-400 group-hover:text-indigo-500" />
                           <span className="text-xs text-slate-500 dark:text-slate-400 group-hover:text-indigo-600 font-medium">Ø§Ø¶ØºØ· Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù„Ù JSON</span>
                        </>
                     )}
                     <input 
                        type="file" 
                        ref={restoreFileRef}
                        className="hidden" 
                        accept=".json" 
                        onChange={handleRestoreBackup} 
                        disabled={isRestoring || readOnly}
                     />
                  </label>
               </div>

               {/* Auto Backup Settings */}
               <div className="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700 mt-2">
                  <div className="flex items-center justify-between">
                     <div className="flex items-center gap-2 text-slate-600 dark:text-slate-300 text-xs font-bold">
                        <HardDrive className="w-3 h-3" />
                        <span>Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                     </div>
                     <select 
                       className="bg-transparent border-none text-xs font-bold text-indigo-600 dark:text-indigo-400 outline-none cursor-pointer text-right"
                       value={generalSettings.autoBackup}
                       onChange={e => setGeneralSettings({...generalSettings, autoBackup: e.target.value})}
                       disabled={readOnly}
                     >
                       <option value="daily">ÙŠÙˆÙ…ÙŠØ§Ù‹</option>
                       <option value="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹</option>
                       <option value="monthly">Ø´Ù‡Ø±ÙŠØ§Ù‹</option>
                       <option value="off">Ø¥ÙŠÙ‚Ø§Ù</option>
                     </select>
                  </div>
               </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  );

  const renderReportsTab = () => (
    <div className="space-y-6 animate-in fade-in">
      {/* Report Settings Card */}
      <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
        <div className="flex items-center gap-3 mb-4">
          <FileReport className="w-8 h-8 text-green-600" />
          <h4 className="font-bold text-slate-800 dark:text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
        </div>
        <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
          ØªØ®ØµÙŠØµ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©
        </p>
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <select
              value={reportSettings.dateRange}
              onChange={(e) => setReportSettings({...reportSettings, dateRange: e.target.value})}
              className="w-full border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 dark:text-white"
              disabled={readOnly}
            >
              <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª</option>
              <option value="month">Ø¢Ø®Ø± Ø´Ù‡Ø±</option>
              <option value="quarter">Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±</option>
              <option value="year">Ø¢Ø®Ø± Ø³Ù†Ø©</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ØµÙŠØºØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
            <select
              value={reportSettings.format}
              onChange={(e) => setReportSettings({...reportSettings, format: e.target.value})}
              className="w-full border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 dark:text-white"
              disabled={readOnly}
            >
              <option value="pdf">PDF</option>
              <option value="excel">Excel</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          
          <div className="flex items-center gap-3">
            <input
              type="checkbox"
              id="includeArchived"
              checked={reportSettings.includeArchived}
              onChange={(e) => setReportSettings({...reportSettings, includeArchived: e.target.checked})}
              className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
              disabled={readOnly}
            />
            <label htmlFor="includeArchived" className="text-sm text-slate-700 dark:text-slate-300">
              ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©
            </label>
          </div>
          
          <div className="flex items-center gap-3">
            <input
              type="checkbox"
              id="autoPrint"
              checked={reportSettings.autoPrint}
              onChange={(e) => setReportSettings({...reportSettings, autoPrint: e.target.checked})}
              className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"
              disabled={readOnly}
            />
            <label htmlFor="autoPrint" className="text-sm text-slate-700 dark:text-slate-300">
              Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
            </label>
          </div>
        </div>
      </div>

      {/* Generate Report Card */}
      <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
        <div className="flex items-center gap-3 mb-4">
          <Printer className="w-8 h-8 text-blue-600" />
          <h4 className="font-bold text-slate-800 dark:text-white">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h4>
        </div>
        <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">
          Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        </p>
        <div className="space-y-3">
          <button
            onClick={handleGenerateReport}
            disabled={isGeneratingReport || readOnly}
            className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            {isGeneratingReport ? (
              <span className="flex items-center justify-center gap-2">
                <Loader2 className="w-4 h-4 animate-spin" />
                Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...
              </span>
            ) : 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±'}
          </button>
          
          <button
            onClick={handlePrintReport}
            disabled={readOnly}
            className="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            <Printer className="w-4 h-4 inline ml-2" /> Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
          </button>
        </div>
      </div>

      {/* Report Preview */}
      <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
        <div className="flex items-center gap-3 mb-4">
          <FileText className="w-8 h-8 text-purple-600" />
          <h4 className="font-bold text-slate-800 dark:text-white">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h4>
        </div>
        <div ref={reportRef} className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg">
              <div className="text-2xl font-bold text-indigo-600 dark:text-indigo-400">{cases.length}</div>
              <div className="text-sm text-slate-600 dark:text-slate-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø¶Ø§ÙŠØ§</div>
            </div>
            <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg">
              <div className="text-2xl font-bold text-green-600 dark:text-green-400">{cases.filter(c => c.status === 'Ù…ÙØªÙˆØ­Ø©').length}</div>
              <div className="text-sm text-slate-600 dark:text-slate-400">Ù‚Ø¶Ø§ÙŠØ§ Ù…ÙØªÙˆØ­Ø©</div>
            </div>
            <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg">
              <div className="text-2xl font-bold text-red-600 dark:text-red-400">{cases.filter(c => c.status === 'Ù…ØºÙ„Ù‚Ø©').length}</div>
              <div className="text-sm text-slate-600 dark:text-slate-400">Ù‚Ø¶Ø§ÙŠØ§ Ù…ØºÙ„Ù‚Ø©</div>
            </div>
          </div>
          
          <div className="mt-6">
            <h5 className="font-bold text-slate-800 dark:text-white mb-3">Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h5>
            <div className="bg-slate-50 dark:bg-slate-700 p-4 rounded-lg">
              <p className="text-sm text-slate-600 dark:text-slate-400">
                Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù€ <span className="font-bold text-indigo-600">{cases.length}</span> Ù‚Ø¶ÙŠØ©
                {reportSettings.dateRange !== 'all' && (
                  <span> Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ({reportSettings.dateRange === 'month' ? 'Ø¢Ø®Ø± Ø´Ù‡Ø±' : reportSettings.dateRange === 'quarter' ? 'Ø¢Ø®Ø± 3 Ø£Ø´Ù‡Ø±' : 'Ø¢Ø®Ø± Ø³Ù†Ø©'})</span>
                )}
                {reportSettings.includeArchived && (
                  <span> Ù…Ø¹ ØªØ¶Ù…ÙŠÙ† <span className="font-bold text-orange-600">{archivedCases.length}</span> Ù‚Ø¶ÙŠØ© Ù…Ø¤Ø±Ø´ÙØ©</span>
                )}
                Ø¨ØµÙŠØºØ© <span className="font-bold text-green-600">{reportSettings.format.toUpperCase()}</span>
                {reportSettings.autoPrint && (
                  <span> Ù…Ø¹ Ø·Ø¨Ø§Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</span>
                )}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );

  const renderUsersTab = () => (
    <div className="space-y-6 animate-in fade-in">
      <div className="flex justify-between items-center mb-4">
        <div>
          <h3 className="text-lg font-bold text-slate-800 dark:text-white">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h3>
          <p className="text-sm text-slate-500 dark:text-slate-400">ØªØ­ÙƒÙ… ÙÙŠ Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆÙ…Ø§ ÙŠÙ…ÙƒÙ†Ù‡ ÙØ¹Ù„Ù‡</p>
        </div>
        {!readOnly && (
          <button 
            onClick={openAddUser}
            className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 flex items-center gap-2 shadow-sm"
          >
            <Plus className="w-4 h-4" /> Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
          </button>
        )}
      </div>

      <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
        <table className="w-full text-right">
          <thead className="bg-slate-50 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs uppercase font-bold border-b border-slate-200 dark:border-slate-600">
            <tr>
              <th className="p-4">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th className="p-4">Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
              <th className="p-4">Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
              <th className="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th className="p-4">Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th>
              <th className="p-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
            {users.map(user => (
              <tr key={user.id} className="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors dark:text-slate-200">
                <td className="p-4">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold">
                      {user.avatar ? <img src={user.avatar} className="w-full h-full rounded-full object-cover"/> : user.name.charAt(0)}
                    </div>
                    <div>
                      <p className="font-bold text-slate-800 dark:text-white">{user.name}</p>
                      <p className="text-xs text-slate-500 dark:text-slate-400">{user.email}</p>
                    </div>
                  </div>
                </td>
                <td className="p-4 font-mono text-slate-600 dark:text-slate-400 text-xs">
                   {user.username || '-'}
                </td>
                <td className="p-4">
                  <span className="bg-slate-100 dark:bg-slate-600 text-slate-600 dark:text-slate-300 px-2 py-1 rounded text-xs font-bold border border-slate-200 dark:border-slate-500">
                    {user.roleLabel}
                  </span>
                </td>
                <td className="p-4">
                  <span className={`px-2 py-1 rounded-full text-xs font-bold ${user.isActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {user.isActive ? 'Ù†Ø´Ø·' : 'Ù…ÙˆÙ‚ÙˆÙ'}
                  </span>
                </td>
                <td className="p-4 text-slate-500 dark:text-slate-400 font-mono text-xs">
                  {user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('ar-EG') : 'Ù„Ù… ÙŠØ¯Ø®Ù„ Ø¨Ø¹Ø¯'}
                </td>
                <td className="p-4">
                  <div className="flex items-center justify-center gap-2">
                    <button onClick={() => openEditUser(user)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900 rounded-lg transition-colors" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª">
                      <Shield className="w-4 h-4" />
                    </button>
                    {onDeleteUser && !readOnly && (
                      <button onClick={() => onDeleteUser(user.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900 rounded-lg transition-colors" title="Ø­Ø°Ù">
                        <Trash2 className="w-4 h-4" />
                      </button>
                    )}
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );

  const renderSecurityTab = () => (
    <div className="space-y-6 animate-in fade-in">
       {/* Password Change Card */}
       <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <h4 className="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-3">
             <Key className="w-5 h-5 text-indigo-600" /> ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
          </h4>
          <form onSubmit={handlePasswordChange} className="max-w-md space-y-4">
             <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                <input 
                  type="password" 
                  required
                  className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                  value={securityData.currentPassword}
                  onChange={e => setSecurityData({...securityData, currentPassword: e.target.value})}
                />
             </div>
             <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input 
                  type="password" 
                  required
                  minLength={8}
                  className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                  value={securityData.newPassword}
                  onChange={e => setSecurityData({...securityData, newPassword: e.target.value})}
                />
             </div>
             <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                <input 
                  type="password" 
                  required
                  minLength={8}
                  className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                  value={securityData.confirmPassword}
                  onChange={e => setSecurityData({...securityData, confirmPassword: e.target.value})}
                />
             </div>
             <button type="submit" disabled={isSaving} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors w-full sm:w-auto flex justify-center items-center gap-2">
                {isSaving && <Loader2 className="w-4 h-4 animate-spin" />}
                {isSaving ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...' : 'ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'}
             </button>
          </form>
       </div>

       {/* 2FA Card */}
       <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <div className="flex justify-between items-center">
             <div>
                <h4 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                   <Shield className="w-5 h-5 text-green-600" /> Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠØ© (2FA)
                </h4>
                <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ø¨Ø± Ø±Ù…Ø² ÙŠØµÙ„ Ù„Ù‡Ø§ØªÙÙƒ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</p>
             </div>
             <label className="relative inline-flex items-center cursor-pointer">
               <input type="checkbox" className="sr-only peer" checked={securityData.twoFactorEnabled} onChange={e => setSecurityData({...securityData, twoFactorEnabled: e.target.checked})} />
               <div className="w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
             </label>
          </div>
       </div>

       {/* Active Sessions */}
       <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
          <h4 className="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2 border-b border-slate-100 dark:border-slate-700 pb-3">
             <Smartphone className="w-5 h-5 text-blue-600" /> Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©
          </h4>
          <div className="space-y-4">
             <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg">
                <div className="flex items-center gap-3">
                   <div className="bg-white dark:bg-slate-600 p-2 rounded-full text-slate-600 dark:text-slate-300">
                      <Globe className="w-5 h-5" />
                   </div>
                   <div>
                      <p className="text-sm font-bold text-slate-800 dark:text-white">Windows PC - Chrome</p>
                      <p className="text-xs text-slate-500 dark:text-slate-400">Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŒ Ù…ØµØ± â€¢ Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</p>
                   </div>
                </div>
                <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
             </div>
             <div className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/50 rounded-lg opacity-75">
                <div className="flex items-center gap-3">
                   <div className="bg-white dark:bg-slate-600 p-2 rounded-full text-slate-600 dark:text-slate-300">
                      <Smartphone className="w-5 h-5" />
                   </div>
                   <div>
                      <p className="text-sm font-bold text-slate-800 dark:text-white">iPhone 13 - Safari</p>
                      <p className="text-xs text-slate-500 dark:text-slate-400">Ø§Ù„Ø¬ÙŠØ²Ø©ØŒ Ù…ØµØ± â€¢ Ù…Ù†Ø° 2 Ø³Ø§Ø¹Ø©</p>
                   </div>
                </div>
                <button className="text-xs text-red-600 hover:underline font-bold flex items-center gap-1">
                   <LogOut className="w-3 h-3" /> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                </button>
             </div>
          </div>
       </div>
    </div>
  );

  return (
    <div className="flex flex-col lg:flex-row gap-6 min-h-[500px]">
      {/* Sidebar */}
      <div className="w-full lg:w-64 shrink-0">
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
          <div className="p-4 bg-slate-50 dark:bg-slate-700 border-b border-slate-100 dark:border-slate-600">
            <h2 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
              <SettingsIcon className="w-5 h-5 text-indigo-600" /> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            </h2>
          </div>
          <nav className="p-2 space-y-1">
            <button 
              onClick={() => setActiveTab('general')}
              className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'general' ? 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
            >
              <SettingsIcon className="w-4 h-4" /> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©
            </button>
            <button 
              onClick={() => setActiveTab('security')}
              className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'security' ? 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
            >
              <Lock className="w-4 h-4" /> Ø§Ù„Ø£Ù…Ø§Ù†
            </button>
            <button 
              onClick={() => setActiveTab('users')}
              className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'users' ? 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
            >
              <Users className="w-4 h-4" /> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
            </button>
            <button 
              onClick={() => setActiveTab('reports')}
              className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'reports' ? 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
            >
              <FileReport className="w-4 h-4" /> Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            </button>
            <button 
              onClick={() => setActiveTab('dataManagement')}
              className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${activeTab === 'dataManagement' ? 'bg-indigo-50 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-200' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}
            >
              <Database className="w-4 h-4" /> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
            </button>
          </nav>
        </div>
      </div>

      {/* Content */}
      <div className="flex-1">
        {activeTab === 'general' && renderGeneralTab()}
        {activeTab === 'security' && renderSecurityTab()}
        {activeTab === 'users' && renderUsersTab()}
        {activeTab === 'reports' && renderReportsTab()}
        {activeTab === 'dataManagement' && renderDataManagementTab()}
      </div>

      {/* User Modal (Add/Edit) */}
      {isUserModalOpen && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col animate-in zoom-in-95 duration-200">
            {/* Header */}
            <div className="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50">
              <div>
                <h3 className="font-bold text-lg text-slate-800 dark:text-white">{editingUser ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯'}</h3>
                <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ø¯Ù‚Ø©</p>
              </div>
              <button onClick={() => setIsUserModalOpen(false)} className="text-slate-400 hover:text-red-500 transition-colors">
                <X className="w-6 h-6" />
              </button>
            </div>

            <form onSubmit={handleSaveUser} className="flex-1 overflow-y-auto p-6 space-y-8">
              
              {/* Basic Info Section */}
              <div className="space-y-4">
                <h4 className="text-sm font-bold text-indigo-600 dark:text-indigo-400 border-b border-indigo-100 dark:border-indigo-900/50 pb-2 mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span className="text-red-500">*</span></label>
                    <input 
                      type="text" 
                      required 
                      className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                      value={formData.name}
                      onChange={e => setFormData({...formData, name: e.target.value})}
                      disabled={readOnly}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ <span className="text-red-500">*</span></label>
                    <input 
                      type="email" 
                      required 
                      className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                      dir="ltr"
                      value={formData.email}
                      onChange={e => setFormData({...formData, email: e.target.value})}
                      disabled={readOnly}
                    />
                  </div>
                  
                  {/* Username & Password */}
                  <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ù„Ø¯Ø®ÙˆÙ„)</label>
                    <input 
                      type="text" 
                      className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                      placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±ÙŠØ¯)"
                      value={formData.username || ''}
                      onChange={e => setFormData({...formData, username: e.target.value})}
                      disabled={readOnly}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                       ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± {editingUser ? <span className="text-xs text-slate-400 font-normal">(Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠØ©)</span> : <span className="text-red-500">*</span>}
                    </label>
                    <div className="relative">
                       <input 
                         type="password" 
                         className="w-full border p-2.5 pl-10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                         placeholder={editingUser ? "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©"}
                         required={!editingUser}
                         value={formData.password || ''}
                         onChange={e => setFormData({...formData, password: e.target.value})}
                         disabled={readOnly}
                       />
                       <Key className="w-4 h-4 text-slate-400 absolute left-3 top-3.5" />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                    <input 
                      type="text" 
                      className="w-full border p-2.5 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                      placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ø§Ù…ÙŠ Ø§Ø³ØªØ¦Ù†Ø§Ù"
                      value={formData.roleLabel}
                      onChange={e => setFormData({...formData, roleLabel: e.target.value})}
                      disabled={readOnly}
                    />
                  </div>
                  <div className="flex items-end pb-2">
                    <label className="flex items-center gap-3 cursor-pointer">
                      <div className="relative">
                        <input 
                          type="checkbox" 
                          className="sr-only peer"
                          checked={formData.isActive}
                          onChange={e => setFormData({...formData, isActive: e.target.checked})}
                          disabled={readOnly}
                        />
                        <div className="w-11 h-6 bg-gray-200 dark:bg-slate-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                      </div>
                      <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·</span>
                    </label>
                  </div>
                </div>
              </div>

              {/* Permissions Matrix Section */}
              <div className="space-y-4">
                <h4 className="text-sm font-bold text-indigo-600 dark:text-indigo-400 border-b border-indigo-100 dark:border-indigo-900/50 pb-2 mb-4 flex items-center gap-2">
                  <Shield className="w-4 h-4" /> Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                </h4>
                
                <div className="border border-slate-200 dark:border-slate-700 rounded-xl overflow-hidden">
                  <div className="grid grid-cols-4 bg-slate-50 dark:bg-slate-900/50 p-3 text-xs font-bold text-slate-600 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">
                    <div className="col-span-1">Ø§Ù„ØµÙØ­Ø© / Ø§Ù„ÙˆØ­Ø¯Ø©</div>
                    <div className="flex justify-center items-center gap-1"><Ban className="w-3 h-3 text-slate-400"/> Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ©</div>
                    <div className="flex justify-center items-center gap-1"><Eye className="w-3 h-3 text-blue-500"/> Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·</div>
                    <div className="flex justify-center items-center gap-1"><Pencil className="w-3 h-3 text-green-500"/> ØªØ¹Ø¯ÙŠÙ„ ÙˆØ¥Ø¯Ø®Ø§Ù„</div>
                  </div>
                  
                  <div className="divide-y divide-slate-100 dark:divide-slate-700">
                    {MODULES.map(module => {
                      const currentAccess = formData.permissions?.find(p => p.moduleId === module.id)?.access || 'none';
                      
                      return (
                        <div key={module.id} className="grid grid-cols-4 p-3 items-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                          <div className="font-medium text-slate-800 dark:text-slate-200 text-sm">{module.label}</div>
                          
                          {/* Option: None */}
                          <div className="flex justify-center">
                            <label className="cursor-pointer p-2 rounded hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                              <input 
                                type="radio" 
                                name={`perm-${module.id}`} 
                                checked={currentAccess === 'none'}
                                onChange={() => handlePermissionChange(module.id, 'none')}
                                className="sr-only"
                                disabled={readOnly}
                              />
                              <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${currentAccess === 'none' ? 'border-slate-500 bg-slate-500 text-white' : 'border-slate-300 dark:border-slate-600'}`}>
                                {currentAccess === 'none' && <X className="w-3 h-3" />}
                              </div>
                            </label>
                          </div>

                          {/* Option: Read */}
                          <div className="flex justify-center">
                            <label className="cursor-pointer p-2 rounded hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-colors">
                              <input 
                                type="radio" 
                                name={`perm-${module.id}`} 
                                checked={currentAccess === 'read'}
                                onChange={() => handlePermissionChange(module.id, 'read')}
                                className="sr-only"
                                disabled={readOnly}
                              />
                              <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${currentAccess === 'read' ? 'border-blue-500 bg-blue-500 text-white' : 'border-slate-300 dark:border-slate-600'}`}>
                                {currentAccess === 'read' && <Eye className="w-3 h-3" />}
                              </div>
                            </label>
                          </div>

                          {/* Option: Write */}
                          <div className="flex justify-center">
                            <label className="cursor-pointer p-2 rounded hover:bg-green-50 dark:hover:bg-green-900/30 transition-colors">
                              <input 
                                type="radio" 
                                name={`perm-${module.id}`} 
                                checked={currentAccess === 'write'}
                                onChange={() => handlePermissionChange(module.id, 'write')}
                                className="sr-only"
                                disabled={readOnly}
                              />
                              <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${currentAccess === 'write' ? 'border-green-500 bg-green-500 text-white' : 'border-slate-300 dark:border-slate-600'}`}>
                                {currentAccess === 'write' && <Check className="w-3 h-3" />}
                              </div>
                            </label>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>

            </form>

            <div className="p-5 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50 flex gap-3 justify-end">
              <button 
                type="button" 
                onClick={() => setIsUserModalOpen(false)}
                className="px-5 py-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
              >
                Ø¥Ù„ØºØ§Ø¡
              </button>
              {!readOnly && (
                <button 
                  onClick={handleSaveUser}
                  className="px-6 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-md shadow-indigo-200 dark:shadow-none flex items-center gap-2 transition-colors"
                >
                  <Save className="w-4 h-4" /> Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                </button>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Settings;
